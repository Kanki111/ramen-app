<%= form_with(model: member_post, local: true) do |form| %>
  <% if member_post.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(member_post.errors.count, "error") %> prohibited this member_post from being saved:</h2>

      <ul>
        <% member_post.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :店名, class: "form_content_label" %>
    <%= form.text_field :title, class: "form_content_text_field" %>
  </div>

  <div class="field">
    <%= form.label :お店の場所, class: "form_content_label" %>
    <%= form.text_field :place, class: "form_content_text_field" %>
  </div>

  <div class="field">
    <%= form.label :image, class: "form_content_label"  %>
    <%=form.label "画像をアップロード" , class: "new_post_label"%><%= form.file_field :image , class: "new_post_image" %>
  </div>

  <div class="field">
  <%= form.label :お店のページのURL, class: "form_content_label" %>
  <%= form.text_field :ramen_type,  class: "form_content_text_field" %>
</div>


  <div class="field">
    <%= form.label :追加の画像やコメントなど, class: "form_content_label" %>
    <%= form.rich_text_area :content %>
  </div>

  <div class="field">
    <%= form.label :mapの追加, class: "form_content_label" %>

    <input id="address" type="textbox" value="GeekSalon">
<input type="button" value="Encode" onclick="codeAddress()">
<div id="display"></div>
    <div id="map"></div>
  </div>

  <div class="actions">
    <%= form.submit :投稿をする, class: "new_post_button" %>
  </div>
  
  <script>
  let map
  let geocoder
  const display = document.getElementById('display')
  
  function initMap(){
    geocoder = new google.maps.Geocoder()
  
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 40.7828, lng:-73.9653},
      zoom: 12,
    });
  
    marker = new google.maps.Marker({
      position:  {lat: 40.7828, lng:-73.9653},
      map: map
    });
  }
  
  document.getElementById('search').addEventListener('click', function() {

    var place = document.getElementById('keyword').value;
    var geocoder = new google.maps.Geocoder();      // geocoderのコンストラクタ

    geocoder.geocode({
      address: place
    }, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {

        var bounds = new google.maps.LatLngBounds();

        for (var i in results) {
          if (results[0].geometry) {
            // 緯度経度を取得
            var latlng = results[0].geometry.location;
            // 住所を取得
            var address = results[0].formatted_address;
            // 検索結果地が含まれるように範囲を拡大
            bounds.extend(latlng);
            // マーカーのセット
            setMarker(latlng);
            // マーカーへの吹き出しの追加
            setInfoW(place, latlng, address);
            // マーカーにクリックイベントを追加
            markerEvent();
          }
        }
      } elsif (status == google.maps.GeocoderStatus.ZERO_RESULTS) {
        alert("見つかりません");
      } else {
        console.log(status);
        alert("エラー発生");
      }
    });

  });

  // 結果クリアーボタン押下時
  document.getElementById('clear').addEventListener('click', function() {
    deleteMakers();
  });

}

// マーカーのセットを実施する
function setMarker(setplace) {
  // 既にあるマーカーを削除
  deleteMakers();

  var iconUrl = 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
    marker = new google.maps.Marker({
      position: setplace,
      map: map,
      icon: iconUrl
    });
  }

  //マーカーを削除する
  function deleteMakers() {
    if(marker != null){
      marker.setMap(null);
    }
    marker = null;
  }

  // マーカーへの吹き出しの追加
  function setInfoW(place, latlng, address) {
    infoWindow = new google.maps.InfoWindow({
    content: "<a href='http://www.google.com/search?q=" + place + "' target='_blank'>" + place + "</a><br><br>" + latlng + "<br><br>" + address + "<br><br><a href='http://www.google.com/search?q=" + place + "&tbm=isch' target='_blank'>画像検索 by google</a>"
  });
}

// クリックイベント
function markerEvent() {
  marker.addListener('click', function() {
    infoWindow.open(map, marker);
  });
}

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBfCmlyL2lyPkB-fTxtmVP_q0VEpEtGXW4&language=ja&region=JP&callback=initMap" async defer></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<% end %>
